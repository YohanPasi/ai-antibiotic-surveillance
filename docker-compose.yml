version: '3.8'

services:
  # FastAPI Backend Service
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: ast_api
    restart: always
    volumes:
      - ./api:/app
      - ./database:/app/database_scripts
      - model_data:/app/models/best_models
      - ./api/models/mrsa_artifacts:/app/models/mrsa_artifacts
      - ./Raw:/app/data/raw
      # ESBL Artifact Mounts
      - ./Models:/app/Models
      - ./Config:/app/Config
      - ./Processed:/app/Processed
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://postgres.zdhvyhijuriggezelyxq:Yohan%26pasi80253327@aws-1-ap-northeast-2.pooler.supabase.com:5432/postgres?sslmode=require
      PYTHONUNBUFFERED: 1
    dns:
      - 8.8.8.8
      - 1.1.1.1
    dns_opt:
      - use-vc
      - ndots:1
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # React Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ast_frontend
    restart: always
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    depends_on:
      - api
    environment:
      VITE_API_URL: http://localhost:8000
    stdin_open: true
    tty: true

volumes:
  model_data:
    driver: local

networks:
  default:
    name: ast_network
    driver: bridge

    ipam:
      config:
        - subnet: 172.18.0.0/16
